<% layout("/layouts/boilerplate.ejs") %>

<body class="bg-light py-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        <div class="card shadow-lg rounded-4 overflow-hidden">

          <!-- Listing Image -->
          <img 
            src="<%= listing.image.url %>" 
            alt="Listing Image" 
            class="card-img-top" 
            style="height: 300px; object-fit: cover;"
          >

          <div class="card-body p-4">
            <!-- Title -->
            <h2 class="card-title text-center mb-4 fw-bold text-primary">
              <%= listing.title %>
            </h2>

            <!-- Details List -->
            <ul class="list-group list-group-flush mb-4">
              <li class="list-group-item">
                <strong>Owner:</strong>
                <i><%= listing.owner?.username?.toUpperCase() || "Unknown" %></i>
              </li>
              <li class="list-group-item">
                <strong>Description:</strong> <%= listing.description %>
              </li>
              <li class="list-group-item">
                <strong>Price:</strong> ₹<%= listing.price.toLocaleString("en-IN") %>
              </li>
              <li class="list-group-item">
                <strong>Country:</strong> <%= listing.country %>
              </li>
              <li class="list-group-item">
                <strong>Location:</strong> <%= listing.location %>
              </li>
            </ul>

            <!-- Edit/Delete Buttons for Owner -->
            <% if (currUser && String(currUser._id) === String(listing.owner._id)) { %>
              <div class="d-flex justify-content-between mt-4">
                <form method="get" action="/listings/<%= listing._id %>/edit">
                  <button class="btn btn-warning px-4">Edit</button>
                </form>
                <form method="post" action="/listings/<%= listing._id %>?_method=DELETE" onsubmit="return confirm('Are you sure you want to delete this listing?');">
                  <button class="btn btn-danger px-4">Delete</button>
                </form>
              </div>
            <% } %>

            <!-- Back Button -->
            <div class="text-center mt-4">
              <a href="/listings" class="btn btn-outline-primary">← Back to Listings</a>
            </div>
          </div>
        </div>

        <!-- Review Section -->
        <div class="pt-4">
          <hr class="my-4">
          <h4 class="text-secondary mb-3">Reviews</h4>
        </div>

        <!-- Add Review Form (Only for logged-in users including owner) -->
        <% if (currUser) { %>
          <div class="mb-3 mt-3">
            <form action="/listings/<%= listing._id %>/reviews" method="POST" class="needs-validation" novalidate>

              <!-- Rating Input -->
              <div class="mb-3">
                <label class="form-label d-block fw-semibold text-secondary">Rating:</label>
                <div class="star-rating d-flex justify-content-start flex-row-reverse">
                  <% for (let i = 5; i >= 1; i--) { %>
                    <input type="radio" name="review[rating]" id="star<%= i %>" value="<%= i %>" class="d-none" required>
                    <label for="star<%= i %>" class="star">&#9733;</label>
                  <% } %>
                </div>
              </div>

              <!-- Comment Input -->
              <div class="mb-3">
                <label for="comment" class="form-label">Comment</label>
                <textarea 
                  name="review[comment]" 
                  id="comment" 
                  class="form-control" 
                  rows="3" 
                  required 
                  minlength="3"
                ></textarea>
                <div class="invalid-feedback">
                  Comment is required (min 3 characters).
                </div>
              </div>

              <button type="submit" class="btn btn-outline-primary">Add Review</button>
            </form>
          </div>
        <% } else { %>
          <!-- Prompt login if not logged in -->
          <div class="alert alert-warning">
            <a href="/login" class="alert-link">Log in</a> to add a review.
          </div>
        <% } %>

        <!-- Reviews List (Visible to everyone) -->
        <div class="mt-4">
          <% for (let review of listing.review) { %>
            <% let rating = parseInt(review.rating); %>
            <div class="mb-3 p-3 border rounded bg-white shadow-sm">
              <p><strong>Comment:</strong> <%= review.comment %></p>

              <p><strong>Rating:</strong>
                <% for (let i = 1; i <= 5; i++) { %>
                  <span style="color: <%= i <= rating ? '#ffc107' : '#e4e5e9' %>">&#9733;</span>
                <% } %>
              </p>

              <p class="text-muted small">Posted on: <%= new Date(review.date).toLocaleDateString("en-IN") %></p>
              <p class="text-muted small">By: <%= review.author?.username || "Anonymous" %></p>

              <!-- Delete Review Button (only by review author) -->
              <% if (currUser && String(currUser._id) === String(review.author._id)) { %>
                <form 
                  action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" 
                  method="POST" 
                  onsubmit="return confirm('Are you sure you want to delete this review?');"
                >
                  <button class="btn btn-sm btn-danger mt-2">Delete</button>
                </form>
              <% } %>
            </div>
          <% } %>
        </div>
        <div id="map"></div>
        <script>
  const mapbox = "<%= process.env.MAPTOKEN %>";
  const coordinates = "<%- JSON.stringify(listing.geometry.coordinates) %>";

  console.log("Mapbox token:", mapbox);
  console.log("Coordinates:", coordinates);

  mapboxgl.accessToken = mapbox;

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: coordinates, // Use coordinates to center the map
    zoom: 9
  });

  new mapboxgl.Marker()
      .setLngLat(coordinates)
      .setPopup(new mapboxgl.Popup().setHTML("<p>Location Will be provided after booking</p>")) // optional popup
      .addTo(map);
</script>

        
      </div>
    </div>
  </div>
</body>
